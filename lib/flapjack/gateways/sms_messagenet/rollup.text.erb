<%
  state_counts = @rollup_alerts.inject({}) do |memo, alert|
    memo[alert[1]['state']] = (memo[alert[1]['state']] || 0) + 1
    memo
  end

  states_summary = ['critical', 'warning', 'unknown'].inject([]) do |memo, state|
    next memo unless state_counts[state]
    memo << "#{state.titleize}: #{state_counts[state]}"
    memo
  end.join(', ')

  states_detail = ['critical', 'warning', 'unknown'].inject([]) do |memo, state|

    alerts = @rollup_alerts.find_all {|alert| alert[1]['state'] == state}
    next memo if alerts.to_a.empty?

    memo << "#{state.titleize}: " + alerts.inject([]) do |ret, alert|
      entity, check = alert[0].split(':', 2)
      ret << "'#{check}' on #{entity}"
      ret
    end.join(', ')

    memo
  end.join('; ')

-%>
<% case @rollup -%>
<% when "problem" -%>
<%=  "Problem summary: " -%>
<% when "recovery" -%>
<%=  "Problem summaries finishing: " -%>
<% end -%>
<%= states_summary %> (<%= states_detail -%>)
